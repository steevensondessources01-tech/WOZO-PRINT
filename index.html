<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOZOPRINT - Gestion Imprimerie</title>
    <meta name="theme-color" content="#21B5DE">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #21B5DE 0%, #1A8FB8 100%); min-height: 100vh; padding: 15px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: #FFFFFF; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; border: 3px solid #21B5DE; }
        header { background: #21B5DE; color: white; padding: 20px; text-align: center; border-bottom: 3px solid #FFFFFF; }
        .logo { font-size: 1.8em; font-weight: 800; }
        .tabs { display: flex; background: #E8F7FC; overflow-x: auto; }
        .tab { flex: 1; padding: 15px; text-align: center; border: none; font-weight: 600; color: #1A8FB8; cursor: pointer; font-size: 0.9em; white-space: nowrap; }
        .tab.active { background: #21B5DE; color: white; }
        .tab-content { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #1A8FB8; font-weight: 600; margin-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #D1EFF9; border-radius: 8px; font-size: 16px; outline: none; }
        .services-section { background: #F8FDFF; border: 2px solid #E8F7FC; border-radius: 10px; padding: 15px; margin: 20px 0; }
        .service-row { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #E8F7FC; }
        .quantity-control { display: flex; align-items: center; gap: 5px; }
        .qty-btn { background: #21B5DE; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .qty-input { width: 40px; text-align: center; padding: 5px; border: none; background: transparent; font-weight: bold; }
        .cart-total { background: #21B5DE; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 1.4em; font-weight: 800; margin-top: 15px; }
        .btn-primary { background: #21B5DE; color: white; border: none; font-weight: bold; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; font-size: 1.1em; }
        .btn-secondary { background: white; color: #21B5DE; border: 1px solid #21B5DE; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #21B5DE; color: white; padding: 10px; text-align: left; font-size: 0.8em; }
        td { padding: 10px; border-bottom: 1px solid #E8F7FC; font-size: 0.85em; }
        .hidden { display: none !important; }
        .card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #E8F7FC; }
        .autocomplete-list { position: absolute; background: white; border: 2px solid #21B5DE; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; width: calc(50% - 5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #E8F7FC; }
        .autocomplete-item:hover { background: #E8F7FC; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; overflow: auto; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 3px solid #21B5DE; }
        .stat-card { background: linear-gradient(135deg, #21B5DE, #1A8FB8); color: white; padding: 15px; border-radius: 10px; margin: 10px 0; text-align: center; }
        .payment-badge { display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 0.75em; font-weight: bold; }
        .badge-pending { background: #FFCE56; color: #333; }
        .badge-paid { background: #4BC0C0; color: white; }
        .progress-bar { background: #E8F7FC; border-radius: 10px; overflow: hidden; height: 25px; margin: 5px 0; }
        .progress-fill { background: linear-gradient(90deg, #21B5DE, #1A8FB8); height: 100%; display: flex; align-items: center; padding: 0 10px; color: white; font-weight: bold; font-size: 0.85em; transition: width 0.3s ease; }
        .export-btn { background: #4BC0C0; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px; font-weight: 600; }
        .notification { position: fixed; top: 20px; right: 20px; background: #21B5DE; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10000; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .service-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .service-stat-card { background: white; border: 2px solid #E8F7FC; border-radius: 10px; padding: 15px; text-align: center; }
        .filter-active { background: #21B5DE !important; color: white !important; }
        @media print {
            .tabs, button, input, select, textarea { display: none !important; }
            .tab-content { display: block !important; }
            body { background: white; }
            .container { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header><div class="logo">WOZOPRINT</div><p>Gestion Professionnelle</p></header>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('ventes')">üõí Ventes</button>
            <button class="tab" onclick="showTab('repartition')">üìä Rapports</button>
            <button class="tab" onclick="showTab('clients')">üë• Clients</button>
            <button class="tab" onclick="showTab('inventaire')">üì¶ Inventaire</button>
            <button class="tab" onclick="showTab('backup')">‚öôÔ∏è Options</button>
        </div>
        
        <div id="ventes" class="tab-content">
            <div class="form-group">
                <label>üë§ Client & T√©l√©phone</label>
                <div style="display:flex; gap:10px; position:relative;">
                    <div style="flex:1; position:relative;">
                        <input type="text" id="clientName" placeholder="Nom du client" autocomplete="off">
                        <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
                    </div>
                    <input type="tel" id="clientPhone" placeholder="T√©l√©phone">
                </div>
            </div>
            <div class="services-section"><label>üõ†Ô∏è Services</label><div id="servicesContainer"></div></div>
            <div class="form-group">
                <label>üöö Options & Remise</label>
                <div style="display:flex; gap:10px;">
                    <select id="deliveryOption" onchange="updateTotal()">
                        <option value="0">Pas de livraison</option>
                        <option value="25">Standard (+25 G)</option>
                        <option value="50">Express (+50 G)</option>
                    </select>
                    <input type="number" id="discount" value="0" placeholder="Remise %" onchange="updateTotal()">
                    <select id="paymentMethod">
                        <option value="cash">üíµ Esp√®ces</option>
                        <option value="moncash">üì± Moncash</option>
                        <option value="natcash">üí≥ Natcash</option>
                        <option value="card">üí≥ Carte</option>
                        <option value="credit">üìù Cr√©dit</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>üìù Instructions</label>
                <textarea id="notes" rows="2" placeholder="Ex: Bristol bleu, recto-verso..."></textarea>
            </div>
            <div class="cart-total" id="cartTotal">0 Gdes</div>
            <button class="btn-primary" onclick="createOrder()">ENREGISTRER LA COMMANDE</button>
            <button class="btn-secondary" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;margin-top:10px;width:100%">Annuler la modification</button>

            <h3 style="margin-top: 30px; color: #1A8FB8; border-bottom: 2px solid #E8F7FC; padding-bottom: 5px;">Historique du jour</h3>
            <div style="display:flex; gap:10px; margin:10px 0; flex-wrap:wrap;">
                <button class="btn-secondary filter-active" onclick="filterOrders('all')">Tout</button>
                <button class="btn-secondary" onclick="filterOrders('pending')">√Ä livrer</button>
                <button class="btn-secondary" onclick="filterOrders('paid')">Pay√©</button>
                <input type="text" id="searchOrder" placeholder="üîç Rechercher..." style="flex:1; min-width:200px; padding:8px; border:2px solid #D1EFF9; border-radius:8px;">
            </div>
            <div id="day-summary-container"></div>
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>Heure</th><th>Client</th><th>Services</th><th>Total</th><th>Paiement</th><th>Statut</th><th>Action</th></tr></thead>
                    <tbody id="ordersList"></tbody>
                </table>
            </div>
        </div>

        <div id="repartition" class="tab-content hidden">
            <div style="margin-bottom:20px;">
                <label style="color:#1A8FB8; font-weight:600;">üìÖ P√©riode</label>
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <input type="date" id="startDate" style="flex:1; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    <input type="date" id="endDate" style="flex:1; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    <button class="btn-primary" onclick="loadRepartition()" style="padding:10px 20px; width:auto;">Filtrer</button>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="setDateRange('today')">Aujourd'hui</button>
                    <button class="btn-secondary" onclick="setDateRange('week')">Cette semaine</button>
                    <button class="btn-secondary" onclick="setDateRange('month')">Ce mois</button>
                    <button class="btn-secondary" onclick="setDateRange('all')">Tout</button>
                </div>
            </div>
            <div id="repartitionContainer"></div>
        </div>

        <div id="clients" class="tab-content hidden">
            <h3>Fid√©lit√© Clients</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="searchClient" placeholder="üîç Rechercher un client..." style="flex:1; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                <select id="sortClient" onchange="loadClients()" style="padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    <option value="total">Trier par Total</option>
                    <option value="name">Trier par Nom</option>
                    <option value="count">Trier par Achats</option>
                    <option value="balance">Trier par Balance</option>
                </select>
            </div>
            <div id="clientsContainer"></div>
        </div>

        <div id="inventaire" class="tab-content hidden">
            <h3 style="color:#1A8FB8; margin-bottom:15px;">üì¶ Gestion Inventaire</h3>
            <button class="btn-primary" onclick="showAddProductModal()" style="margin-bottom:15px;">+ Ajouter un produit</button>
            <div id="inventaireContainer"></div>
        </div>

        <div id="backup" class="tab-content hidden">
            <div style="text-align: center; padding: 20px;">
                <h3 style="color:#1A8FB8; margin-bottom:20px;">üíæ Gestion des donn√©es</h3>
                <div class="stat-card">
                    <div style="font-size:2em; font-weight:bold;" id="ordersCount">0</div>
                    <div>Commandes totales</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:2em; font-weight:bold;" id="clientsCount">0</div>
                    <div>Clients enregistr√©s</div>
                </div>
                <div style="background:#E8F7FC; padding:15px; border-radius:10px; margin:15px 0; text-align:left;">
                    <strong>üìÖ Derni√®re sauvegarde auto:</strong><br>
                    <span id="lastBackupDate">Jamais</span>
                </div>
                <button class="btn-primary" onclick="exportData()" style="background:#4BC0C0">üì• T√©l√©charger Sauvegarde</button>
                <button class="btn-secondary" onclick="importData()" style="margin-top: 15px; width: 100%;">üì§ Restaurer un fichier</button>
                <button class="btn-secondary" onclick="clearAllData()" style="margin-top: 15px; width: 100%; background:#FF6384; color:white; border:none;">üóëÔ∏è Effacer toutes les donn√©es</button>
            </div>
        </div>
    </div>

    <script>
        const SERVICES = [
            { id: 'copie', name: 'Copie simple', price: 5, icon: 'üìÑ' },
            { id: 'noirblanc', name: 'Impression N&B', price: 15, icon: '‚ö´' },
            { id: 'couleur', name: 'Impression couleur', price: 25, icon: 'üé®' },
            { id: 'reliure', name: 'Reliure', price: 20, icon: 'üìé' },
            { id: 'plastification', name: 'Plastification', price: 30, icon: 'üõ°Ô∏è' },
            { id: 'bristol', name: 'Page Couverture (Bristol)', price: 50, icon: 'üìã' },
            { id: 'saisie', name: 'Saisie / Traitement (Page)', price: 50, icon: '‚å®Ô∏è' }
        ];

        let selectedServices = [];
        let orders = JSON.parse(localStorage.getItem('wozoprint_orders')) || [];
        let clients = JSON.parse(localStorage.getItem('wozoprint_clients')) || [];
        let editingOrderId = null;
        let currentFilter = 'all';
        let inventory = JSON.parse(localStorage.getItem('wozoprint_inventory')) || [
            { id: 'paper_a4', name: 'Papier A4', quantity: 500, unit: 'feuilles', minStock: 100, price: 2 },
            { id: 'ink_black', name: 'Encre Noir', quantity: 10, unit: 'cartouches', minStock: 2, price: 500 },
            { id: 'ink_color', name: 'Encre Couleur', quantity: 5, unit: 'cartouches', minStock: 2, price: 800 }
        ];

        document.addEventListener('DOMContentLoaded', () => { 
            initServices(); 
            loadOrders(); 
            setupAutoBackup(); 
            setupAutocomplete(); 
            setupSearchListeners();
        });

        function setupSearchListeners() {
            document.getElementById('searchOrder')?.addEventListener('input', loadOrders);
        }

        function initServices() {
            const container = document.getElementById('servicesContainer');
            SERVICES.forEach(s => {
                const div = document.createElement('div');
                div.className = 'service-row';
                div.innerHTML = `<input type="checkbox" style="width:20px" id="check_${s.id}" onchange="toggleService('${s.id}')">
                    <div style="flex:1"><strong>${s.icon} ${s.name}</strong><br><small>${s.price} Gdes</small></div>
                    <div class="quantity-control hidden" id="qty_${s.id}">
                        <button class="qty-btn" onclick="changeQty('${s.id}', -1)">-</button>
                        <input type="number" class="qty-input" value="1" id="input_${s.id}" readonly>
                        <button class="qty-btn" onclick="changeQty('${s.id}', 1)">+</button>
                        <input type="number" style="width:60px;margin-left:5px;padding:5px;border:1px solid #D1EFF9;border-radius:5px" 
                            placeholder="Remise%" id="discount_${s.id}" onchange="updateTotal()">
                    </div>`;
                container.appendChild(div);
            });
        }

        function toggleService(id) {
            const check = document.getElementById(`check_${id}`);
            const qtyDiv = document.getElementById(`qty_${id}`);
            if (check.checked) {
                selectedServices.push({ ...SERVICES.find(s => s.id === id), quantity: 1, discount: 0 });
                qtyDiv.classList.remove('hidden');
            } else {
                selectedServices = selectedServices.filter(s => s.id !== id);
                qtyDiv.classList.add('hidden');
            }
            updateTotal();
        }

        function changeQty(id, delta) {
            const s = selectedServices.find(s => s.id === id);
            if (s) { s.quantity = Math.max(1, s.quantity + delta); document.getElementById(`input_${id}`).value = s.quantity; updateTotal(); }
        }

        function updateTotal() {
            let total = selectedServices.reduce((acc, s) => {
                const serviceDiscount = parseFloat(document.getElementById(`discount_${s.id}`)?.value) || 0;
                const serviceTotal = s.price * s.quantity * (1 - serviceDiscount / 100);
                return acc + serviceTotal;
            }, 0);
            total += parseInt(document.getElementById('deliveryOption').value);
            total *= (1 - (parseInt(document.getElementById('discount').value) || 0) / 100);
            document.getElementById('cartTotal').textContent = Math.round(total) + ' Gdes';
            return Math.round(total);
        }

        function createOrder() {
            const name = document.getElementById('clientName').value.trim();
            if (!name || !selectedServices.length) {
                showNotification('‚ö†Ô∏è Nom et service requis !');
                return;
            }
            
            const servicesData = selectedServices.map(s => ({
                serviceName: s.name,
                serviceIcon: s.icon,
                price: s.price,
                quantity: s.quantity,
                discount: parseFloat(document.getElementById(`discount_${s.id}`)?.value) || 0
            }));

            const order = {
                id: editingOrderId || Date.now(),
                date: new Date().toISOString(),
                clientName: name,
                clientPhone: document.getElementById('clientPhone').value || 'N/A',
                services: servicesData,
                total: updateTotal(),
                status: '√Ä livrer',
                notes: document.getElementById('notes').value,
                paymentMethod: document.getElementById('paymentMethod').value
            };

            if (editingOrderId) {
                const idx = orders.findIndex(o => o.id === editingOrderId);
                if (idx !== -1) {
                    const oldOrder = orders[idx];
                    if (oldOrder.status === 'Pay√©') correctRepartition(oldOrder.total);
                    orders[idx] = order;
                }
                editingOrderId = null;
                showNotification('‚úÖ Commande modifi√©e avec succ√®s!');
            } else {
                orders.push(order);
                showNotification('‚úÖ Commande enregistr√©e avec succ√®s!');
            }

            localStorage.setItem('wozoprint_orders', JSON.stringify(orders));
            updateClientData(name, order.clientPhone, order.total);
            
            setTimeout(() => location.reload(), 800);
        }

        function loadOrders() {
            const container = document.getElementById('ordersList');
            const summaryContainer = document.getElementById('day-summary-container');
            const today = new Date().toISOString().split('T')[0];
            let todayOrders = orders.filter(o => o.date.startsWith(today)).reverse();
            
            const searchTerm = document.getElementById('searchOrder')?.value.toLowerCase() || '';
            if (searchTerm) {
                todayOrders = todayOrders.filter(o => 
                    o.clientName.toLowerCase().includes(searchTerm) ||
                    o.clientPhone.toLowerCase().includes(searchTerm) ||
                    o.services.some(s => s.serviceName.toLowerCase().includes(searchTerm))
                );
            }
            
            if (currentFilter === 'pending') {
                todayOrders = todayOrders.filter(o => o.status === '√Ä livrer');
            } else if (currentFilter === 'paid') {
                todayOrders = todayOrders.filter(o => o.status === 'Pay√©');
            }
            
            const totalCash = todayOrders.reduce((sum, o) => sum + o.total, 0);
            const paidCount = todayOrders.filter(o => o.status === 'Pay√©').length;
            const pendingCount = todayOrders.filter(o => o.status === '√Ä livrer').length;
            
            summaryContainer.innerHTML = todayOrders.length > 0 ? `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; margin:10px 0;">
                    <div style="background: linear-gradient(135deg, #21B5DE, #1A8FB8); padding: 15px; border-radius: 8px; color: white; text-align:center;">
                        <div style="font-size:2em; font-weight:bold;">${todayOrders.length}</div>
                        <div style="font-size:0.9em;">Commandes</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4BC0C0, #36A2EB); padding: 15px; border-radius: 8px; color: white; text-align:center;">
                        <div style="font-size:2em; font-weight:bold;">${Math.round(totalCash)} G</div>
                        <div style="font-size:0.9em;">Total du jour</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFCE56, #FF6384); padding: 15px; border-radius: 8px; color: white; text-align:center;">
                        <div style="font-size:2em; font-weight:bold;">${pendingCount}</div>
                        <div style="font-size:0.9em;">√Ä livrer</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #36A2EB, #4BC0C0); padding: 15px; border-radius: 8px; color: white; text-align:center;">
                        <div style="font-size:2em; font-weight:bold;">${paidCount}</div>
                        <div style="font-size:0.9em;">Pay√©</div>
                    </div>
                </div>
            ` : "";

            container.innerHTML = todayOrders.length ? todayOrders.map(o => `<tr>
                <td>${new Date(o.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                <td><strong>${o.clientName}</strong><br><small style="color:#999">${o.clientPhone}</small></td>
                <td>${o.services.map(s => `${s.serviceIcon} ${s.serviceName} (√ó${s.quantity})${s.discount ? ` <span style="color:#FF6384">-${s.discount}%</span>` : ''}`).join('<br>')}</td>
                <td><strong>${o.total} G</strong></td>
                <td><small>${getPaymentIcon(o.paymentMethod || 'cash')}</small></td>
                <td><select onchange="updateStatus(${o.id}, this.value)" style="padding:5px; border-radius:5px; border:2px solid #D1EFF9;">
                    <option ${o.status==='√Ä livrer'?'selected':''}>√Ä livrer</option>
                    <option ${o.status==='Pay√©'?'selected':''}>Pay√©</option>
                </select></td>
                <td>
                    <button onclick="editOrder(${o.id})" style="margin-right:5px; background:none; border:none; cursor:pointer; font-size:1.2em;" title="Modifier">‚úèÔ∏è</button>
                    <button onclick="deleteOrder(${o.id})" style="background:none; border:none; cursor:pointer; font-size:1.2em;" title="Supprimer">‚ùå</button>
                </td>
            </tr>`).join('') : '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999">Aucune vente trouv√©e</td></tr>';
        }

        function getPaymentIcon(method) {
            const icons = {
                'cash': 'üíµ Esp√®ces',
                'moncash': 'üì± Moncash',
                'natcash': 'üí≥ Natcash',
                'card': 'üí≥ Carte',
                'credit': 'üìù Cr√©dit'
            };
            return icons[method] || 'üíµ Esp√®ces';
        }

        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('#ventes .btn-secondary').forEach(btn => btn.classList.remove('filter-active'));
            event.target.classList.add('filter-active');
            loadOrders();
        }

        function updateStatus(id, status) {
            const o = orders.find(o => o.id === id);
            if (o.status !== 'Pay√©' && status === 'Pay√©') {
                const history = JSON.parse(localStorage.getItem('wozoprint_repartition')) || [];
                history.push({ date: new Date().toISOString(), amount: o.total, repartition: { amortissement: o.total*0.1, produits: o.total*0.3, tante: o.total*0.15, imprevu: o.total*0.05, mapart: o.total*0.4 }});
                localStorage.setItem('wozoprint_repartition', JSON.stringify(history));
            }
            o.status = status;
            localStorage.setItem('wozoprint_orders', JSON.stringify(orders));
        }

        function loadRepartition() {
            const history = JSON.parse(localStorage.getItem('wozoprint_repartition')) || [];
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;
            
            let filteredHistory = history;
            if (startDate) {
                filteredHistory = filteredHistory.filter(h => new Date(h.date) >= new Date(startDate));
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59);
                filteredHistory = filteredHistory.filter(h => new Date(h.date) <= end);
            }
            
            const t = filteredHistory.reduce((acc, c) => { 
                acc.total += c.amount; 
                acc.a += c.repartition.amortissement; 
                acc.p += c.repartition.produits; 
                acc.h += c.repartition.tante; 
                acc.i += c.repartition.imprevu; 
                acc.m += c.repartition.mapart; 
                return acc; 
            }, {total:0, a:0, p:0, h:0, i:0, m:0});
            
            const paidOrders = orders.filter(o => o.status === 'Pay√©');
            const serviceStats = calculateServiceStats(paidOrders);
            const paymentStats = calculatePaymentStats(paidOrders);
            
            document.getElementById('repartitionContainer').innerHTML = `
                <div style="text-align:center; margin-bottom:20px;">
                    <h2 style="color:#1A8FB8; margin-bottom:10px;">R√©partition Financi√®re</h2>
                    <div class="stat-card" style="display:inline-block; min-width:300px;">
                        <div style="font-size:2.5em; font-weight:bold;">${Math.round(t.total)} G</div>
                        <div style="font-size:0.9em; opacity:0.9;">Total Encaiss√©</div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div style="max-width:300px; margin:0 auto;">
                        <canvas id="repChart"></canvas>
                    </div>
                    <div>
                        <div class="card">
                            <strong>üñ®Ô∏è Amortissement (10%)</strong>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${(t.a/t.total*100)||0}%">${Math.round(t.a)} G</div>
                            </div>
                        </div>
                        <div class="card">
                            <strong>üì¶ Produits (30%)</strong>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${(t.p/t.total*100)||0}%; background:linear-gradient(90deg, #36A2EB, #2E8BC0);">${Math.round(t.p)} G</div>
                            </div>
                        </div>
                        <div class="card">
                            <strong>üè† Logement/Elec (15%)</strong>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${(t.h/t.total*100)||0}%; background:linear-gradient(90deg, #FFCE56, #E5B84F);">${Math.round(t.h)} G</div>
                            </div>
                        </div>
                        <div class="card">
                            <strong>‚ö†Ô∏è Impr√©vus (5%)</strong>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${(t.i/t.total*100)||0}%; background:linear-gradient(90deg, #4BC0C0, #43AAAA);">${Math.round(t.i)} G</div>
                            </div>
                        </div>
                        <div class="card" style="background:linear-gradient(135deg, #21B5DE, #1A8FB8); color:white;">
                            <strong>üí∞ MA PART (40%)</strong>
                            <div class="progress-bar" style="background:rgba(255,255,255,0.3);">
                                <div class="progress-fill" style="width:${(t.m/t.total*100)||0}%; background:rgba(255,255,255,0.9); color:#1A8FB8;">${Math.round(t.m)} G</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="color:#1A8FB8; margin:20px 0 10px 0; border-bottom:2px solid #E8F7FC; padding-bottom:5px;">üìä Statistiques par Service</h3>
                <div class="service-stats">
                    ${Object.entries(serviceStats).map(([name, data]) => `
                        <div class="service-stat-card">
                            <div style="font-size:2em;">${data.icon}</div>
                            <div style="font-weight:bold; color:#1A8FB8; margin:5px 0;">${name}</div>
                            <div style="font-size:1.5em; font-weight:bold; color:#21B5DE;">${data.count}</div>
                            <div style="font-size:0.85em; color:#999;">commandes</div>
                            <div style="font-size:1.2em; font-weight:bold; margin-top:5px;">${data.revenue} G</div>
                        </div>
                    `).join('')}
                </div>

                <h3 style="color:#1A8FB8; margin:20px 0 10px 0; border-bottom:2px solid #E8F7FC; padding-bottom:5px;">üí≥ R√©partition par Mode de Paiement</h3>
                <div class="service-stats">
                    ${Object.entries(paymentStats).map(([method, data]) => `
                        <div class="service-stat-card">
                            <div style="font-size:2em;">${data.icon}</div>
                            <div style="font-weight:bold; color:#1A8FB8; margin:5px 0;">${data.name}</div>
                            <div style="font-size:1.5em; font-weight:bold; color:#21B5DE;">${data.count}</div>
                            <div style="font-size:0.85em; color:#999;">transactions</div>
                            <div style="font-size:1.2em; font-weight:bold; margin-top:5px;">${data.total} G</div>
                            <div style="font-size:0.85em; color:#999;">${Math.round(data.total/t.total*100)}%</div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top:20px; text-align:center;">
                    <button class="export-btn" onclick="exportReport('pdf')">üìÑ Export PDF</button>
                    <button class="export-btn" onclick="exportReport('excel')">üìä Export Excel</button>
                    <button class="export-btn" onclick="printReport()">üñ®Ô∏è Imprimer</button>
                </div>
            `;
            
            new Chart(document.getElementById('repChart'), { 
                type: 'doughnut', 
                data: { 
                    labels: ['Amortissement', 'Produits', 'Logement', 'Impr√©vus', 'Ma Part'],
                    datasets: [{ 
                        data: [t.a, t.p, t.h, t.i, t.m], 
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#21B5DE'] 
                    }] 
                }, 
                options: { 
                    plugins: { 
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${Math.round(ctx.parsed)} G (${Math.round(ctx.parsed/t.total*100)}%)`
                            }
                        }
                    } 
                } 
            });
        }

        function calculateServiceStats(paidOrders) {
            const stats = {};
            paidOrders.forEach(order => {
                order.services.forEach(service => {
                    if (!stats[service.serviceName]) {
                        stats[service.serviceName] = {
                            icon: service.serviceIcon,
                            count: 0,
                            revenue: 0
                        };
                    }
                    stats[service.serviceName].count += service.quantity;
                    stats[service.serviceName].revenue += Math.round(service.price * service.quantity * (1 - (service.discount || 0) / 100));
                });
            });
            return stats;
        }

        function calculatePaymentStats(paidOrders) {
            const stats = {};
            const methods = {
                'cash': { icon: 'üíµ', name: 'Esp√®ces' },
                'moncash': { icon: 'üì±', name: 'Moncash' },
                'natcash': { icon: 'üí≥', name: 'Natcash' },
                'card': { icon: 'üí≥', name: 'Carte' },
                'credit': { icon: 'üìù', name: 'Cr√©dit' }
            };
            
            paidOrders.forEach(order => {
                const method = order.paymentMethod || 'cash';
                if (!stats[method]) {
                    stats[method] = {
                        ...methods[method],
                        count: 0,
                        total: 0
                    };
                }
                stats[method].count++;
                stats[method].total += order.total;
            });
            
            return stats;
        }

        function setDateRange(range) {
            const today = new Date();
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            document.querySelectorAll('#repartition .btn-secondary').forEach(btn => btn.classList.remove('filter-active'));
            event.target.classList.add('filter-active');
            
            endInput.value = today.toISOString().split('T')[0];
            
            switch(range) {
                case 'today':
                    startInput.value = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    startInput.value = weekAgo.toISOString().split('T')[0];
                    break;
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    startInput.value = monthAgo.toISOString().split('T')[0];
                    break;
                case 'all':
                    startInput.value = '';
                    endInput.value = '';
                    break;
            }
            
            loadRepartition();
        }

        function showTab(name) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            if (name === 'repartition') loadRepartition();
            if (name === 'clients') loadClients();
            if (name === 'backup') updateBackupStats();
            if (name === 'inventaire') loadInventory();
        }

        function updateClientData(name, phone, amount) {
            let c = clients.find(cl => cl.name === name);
            if (!c) { 
                clients.push({ name, phone, total: Math.max(0, amount), count: amount > 0 ? 1 : 0, balance: 0 }); 
            } else { 
                c.total = Math.max(0, c.total + amount);
                if (amount > 0) c.count += 1;
                else if (amount < 0 && c.count > 0) c.count -= 1;
            }
            localStorage.setItem('wozoprint_clients', JSON.stringify(clients));
        }

        function loadClients() {
            const container = document.getElementById('clientsContainer');
            const searchTerm = document.getElementById('searchClient')?.value.toLowerCase() || '';
            const sortBy = document.getElementById('sortClient')?.value || 'total';
            
            let filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                (c.phone && c.phone.includes(searchTerm))
            );
            
            filteredClients.sort((a, b) => {
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                if (sortBy === 'count') return b.count - a.count;
                if (sortBy === 'balance') return (b.balance || 0) - (a.balance || 0);
                return b.total - a.total;
            });
            
            container.innerHTML = filteredClients.length ? filteredClients.map(c => `
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap:wrap; gap:10px;">
                        <div style="flex:1; min-width:200px;">
                            <strong style="font-size:1.1em;">${c.name}</strong> 
                            <span style="color:#999; font-size:0.85em;">${c.phone || 'N/A'}</span><br>
                            <small style="color:#1A8FB8">üìä Total: ${c.total} Gdes ‚Ä¢ üõí ${c.count} achats</small><br>
                            <small style="color:${(c.balance || 0) >= 0 ? 'green' : 'red'}; font-weight:bold;">
                                üí∞ Balance: ${(c.balance || 0) >= 0 ? '+' : ''}${c.balance || 0} Gdes
                            </small>
                        </div>
                        <div style="display:flex; gap:5px; flex-wrap:wrap;">
                            <button class="btn-secondary" onclick="viewClientHistory('${c.name.replace(/'/g, "\\'")}')">üìú Historique</button>
                            <button class="btn-secondary" onclick="editClient('${c.name.replace(/'/g, "\\'")}')">‚úèÔ∏è Modifier</button>
                            <button class="btn-secondary" onclick="adjustBalance('${c.name.replace(/'/g, "\\'")}')">üí∞ Balance</button>
                            <button class="btn-secondary" onclick="deleteClient('${c.name.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('') : '<div class="card" style="text-align:center; color:#999;">Aucun client trouv√©</div>';
        }

        function deleteOrder(id) { 
            if(confirm("Supprimer ?")) { 
                const order = orders.find(o => o.id === id);
                if (order && order.status === 'Pay√©') {
                    correctRepartition(order.total);
                    updateClientData(order.clientName, order.clientPhone, -order.total);
                }
                orders = orders.filter(o => o.id !== id); 
                localStorage.setItem('wozoprint_orders', JSON.stringify(orders)); 
                loadOrders(); 
            } 
        }

        function correctRepartition(amount) {
            const history = JSON.parse(localStorage.getItem('wozoprint_repartition')) || [];
            history.push({ 
                date: new Date().toISOString(), 
                amount: -amount, 
                repartition: { 
                    amortissement: -amount*0.1, 
                    produits: -amount*0.3, 
                    tante: -amount*0.15, 
                    imprevu: -amount*0.05, 
                    mapart: -amount*0.4 
                }
            });
            localStorage.setItem('wozoprint_repartition', JSON.stringify(history));
        }

        function editOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            editingOrderId = id;
            document.getElementById('clientName').value = order.clientName;
            document.getElementById('clientPhone').value = order.clientPhone;
            document.getElementById('notes').value = order.notes || '';
            document.getElementById('cancelEditBtn').style.display = 'block';
            document.getElementById('paymentMethod').value = order.paymentMethod || 'cash';
            
            selectedServices = [];
            order.services.forEach(s => {
                const service = SERVICES.find(srv => srv.name === s.serviceName);
                if (service) {
                    document.getElementById(`check_${service.id}`).checked = true;
                    document.getElementById(`qty_${service.id}`).classList.remove('hidden');
                    document.getElementById(`input_${service.id}`).value = s.quantity;
                    document.getElementById(`discount_${service.id}`).value = s.discount || 0;
                    selectedServices.push({ ...service, quantity: s.quantity, discount: s.discount || 0 });
                }
            });
            
            updateTotal();
            window.scrollTo(0, 0);
        }

        function cancelEdit() {
            editingOrderId = null;
            document.getElementById('cancelEditBtn').style.display = 'none';
            location.reload();
        }

        function setupAutocomplete() {
            const input = document.getElementById('clientName');
            const phoneInput = document.getElementById('clientPhone');
            const list = document.getElementById('autocompleteList');
            
            input.addEventListener('input', function() {
                const val = this.value.toLowerCase().trim();
                
                if (val.length < 1) {
                    list.style.display = 'none';
                    return;
                }
                
                const matches = clients.filter(c => c.name.toLowerCase().includes(val));
                
                if (matches.length === 0) {
                    list.style.display = 'none';
                    return;
                }
                
                list.innerHTML = matches.map(c => `
                    <div class="autocomplete-item" onclick="selectClient('${c.name.replace(/'/g, "\\'")}', '${c.phone || ''}')">
                        <strong>${c.name}</strong><br>
                        <small>${c.phone || 'Pas de t√©l√©phone'} ‚Ä¢ ${c.total} Gdes ‚Ä¢ ${c.count} achats</small>
                    </div>
                `).join('');
                
                list.style.display = 'block';
            });
            
            input.addEventListener('blur', function() {
                setTimeout(() => list.style.display = 'none', 200);
            });
            
            document.getElementById('searchClient')?.addEventListener('input', function() {
                loadClients();
            });
        }

        function selectClient(name, phone) {
            document.getElementById('clientName').value = name;
            document.getElementById('clientPhone').value = phone;
            document.getElementById('autocompleteList').style.display = 'none';
        }

        function editClient(name) {
            const client = clients.find(c => c.name === name);
            if (!client) return;
            
            const newName = prompt('Nouveau nom:', client.name);
            const newPhone = prompt('Nouveau t√©l√©phone:', client.phone || '');
            
            if (newName && newName !== client.name) {
                orders.forEach(o => {
                    if (o.clientName === client.name) o.clientName = newName;
                });
                client.name = newName;
            }
            
            if (newPhone !== null) client.phone = newPhone;
            
            localStorage.setItem('wozoprint_clients', JSON.stringify(clients));
            localStorage.setItem('wozoprint_orders', JSON.stringify(orders));
            loadClients();
        }

        function adjustBalance(name) {
            const client = clients.find(c => c.name === name);
            if (!client) return;
            
            const amount = parseFloat(prompt('Montant (+ pour cr√©dit, - pour dette):', '0'));
            if (isNaN(amount)) return;
            
            client.balance = (client.balance || 0) + amount;
            localStorage.setItem('wozoprint_clients', JSON.stringify(clients));
            loadClients();
        }

        function viewClientHistory(name) {
            const clientOrders = orders.filter(o => o.clientName === name).reverse();
            const client = clients.find(c => c.name === name);
            
            if (!clientOrders.length) return alert('Aucun historique');
            
            const totalPaid = clientOrders.filter(o => o.status === 'Pay√©').reduce((sum, o) => sum + o.total, 0);
            const totalPending = clientOrders.filter(o => o.status !== 'Pay√©').reduce((sum, o) => sum + o.total, 0);
            
            const html = `
                <div class="modal-content">
                    <h3 style="color:#1A8FB8; margin-bottom:15px; text-align:center;">üìú Historique - ${name}</h3>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; margin-bottom:20px;">
                        <div class="stat-card">
                            <div style="font-size:1.5em; font-weight:bold;">${clientOrders.length}</div>
                            <div style="font-size:0.9em;">Total commandes</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg, #4BC0C0, #36A2EB);">
                            <div style="font-size:1.5em; font-weight:bold;">${totalPaid} G</div>
                            <div style="font-size:0.9em;">Montant pay√©</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg, #FFCE56, #FF6384);">
                            <div style="font-size:1.5em; font-weight:bold;">${totalPending} G</div>
                            <div style="font-size:0.9em;">En attente</div>
                        </div>
                        <div class="stat-card" style="background:${(client?.balance || 0) >= 0 ? 'linear-gradient(135deg, #4BC0C0, #36A2EB)' : 'linear-gradient(135deg, #FF6384, #FFCE56)'};">
                            <div style="font-size:1.5em; font-weight:bold;">${(client?.balance || 0) >= 0 ? '+' : ''}${client?.balance || 0} G</div>
                            <div style="font-size:0.9em;">Balance</div>
                        </div>
                    </div>
                    
                    <div style="max-height:400px; overflow-y:auto;">
                        ${clientOrders.map(o => `
                            <div class="card" style="border-left:4px solid ${o.status === 'Pay√©' ? '#4BC0C0' : '#FFCE56'}">
                                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                                    <div>
                                        <strong style="color:#1A8FB8;">${new Date(o.date).toLocaleDateString('fr-FR')}</strong>
                                        <small style="color:#999; margin-left:5px;">${new Date(o.date).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}</small>
                                    </div>
                                    <span class="${o.status === 'Pay√©' ? 'badge-paid' : 'badge-pending'} payment-badge">${o.status}</span>
                                </div>
                                <div style="margin:8px 0;">
                                    ${o.services.map(s => `
                                        <div style="font-size:0.9em; padding:3px 0;">
                                            ${s.serviceIcon} ${s.serviceName} √ó ${s.quantity} 
                                            ${s.discount ? `<span style="color:#FF6384;">(-${s.discount}%)</span>` : ''}
                                            <span style="float:right; font-weight:bold;">${Math.round(s.price * s.quantity * (1 - (s.discount || 0) / 100))} G</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${o.notes ? `<div style="background:#F8FDFF; padding:8px; border-radius:5px; font-size:0.85em; margin-top:8px;">üìù ${o.notes}</div>` : ''}
                                <div style="margin-top:8px; padding-top:8px; border-top:1px solid #E8F7FC; text-align:right;">
                                    <strong style="font-size:1.1em; color:#21B5DE;">Total: ${o.total} Gdes</strong>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="btn-primary" onclick="closeModal()" style="margin-top:15px;">Fermer</button>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'clientHistoryModal';
            modal.className = 'modal-overlay';
            modal.innerHTML = html;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
            document.body.appendChild(modal);
        }

        function closeModal() {
            document.getElementById('clientHistoryModal')?.remove();
        }

        function deleteClient(name) {
            if (!confirm(`Supprimer le client "${name}" ?\n\n‚ö†Ô∏è Attention: Les commandes li√©es seront conserv√©es mais sans client associ√©.`)) return;
            
            clients = clients.filter(c => c.name !== name);
            localStorage.setItem('wozoprint_clients', JSON.stringify(clients));
            loadClients();
        }

        function updateBackupStats() {
            const lastBackup = localStorage.getItem('wozoprint_last_backup');
            const dateEl = document.getElementById('lastBackupDate');
            
            if (lastBackup) {
                const date = new Date(lastBackup);
                dateEl.textContent = date.toLocaleDateString('fr-FR') + ' √† ' + date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
            }
            
            document.getElementById('ordersCount').textContent = orders.length;
            document.getElementById('clientsCount').textContent = clients.length;
        }

        function setupAutoBackup() {
            const lastBackup = localStorage.getItem('wozoprint_last_backup');
            const now = new Date();
            
            if (!lastBackup || (now - new Date(lastBackup)) > 23 * 60 * 60 * 1000) {
                const data = { 
                    orders, 
                    clients, 
                    repartition: JSON.parse(localStorage.getItem('wozoprint_repartition')) 
                };
                
                try {
                    localStorage.setItem('wozoprint_auto_backup', JSON.stringify(data));
                    localStorage.setItem('wozoprint_last_backup', now.toISOString());
                    console.log('Sauvegarde automatique effectu√©e');
                } catch(e) {
                    console.error('Erreur sauvegarde auto:', e);
                }
            }
        }

        function exportData() {
            const data = { orders, clients, repartition: JSON.parse(localStorage.getItem('wozoprint_repartition')), inventory };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            const date = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');
            const heure = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}).replace(':', 'h');
            a.href = URL.createObjectURL(blob);
            a.download = `wozoprint_compta_${date}_${heure}.json`;
            a.click();
            showNotification('‚úÖ Sauvegarde t√©l√©charg√©e!');
        }

        function importData() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    const d = JSON.parse(ev.target.result);
                    if (confirm("Importer les donn√©es ?")) {
                        orders = d.orders; clients = d.clients; inventory = d.inventory || inventory;
                        localStorage.setItem('wozoprint_orders', JSON.stringify(orders));
                        localStorage.setItem('wozoprint_clients', JSON.stringify(clients));
                        localStorage.setItem('wozoprint_repartition', JSON.stringify(d.repartition || []));
                        localStorage.setItem('wozoprint_inventory', JSON.stringify(inventory));
                        showNotification('‚úÖ Donn√©es import√©es!');
                        setTimeout(() => location.reload(), 1000);
                    }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCela va supprimer TOUTES les donn√©es:\n‚Ä¢ Toutes les commandes\n‚Ä¢ Tous les clients\n‚Ä¢ Tous les rapports\n‚Ä¢ Inventaire\n\nCette action est IRR√âVERSIBLE!\n\n√ätes-vous absolument s√ªr?')) return;
            
            if (!confirm('Derni√®re confirmation:\n\nVoulez-vous vraiment TOUT effacer?')) return;
            
            localStorage.clear();
            showNotification('‚úÖ Toutes les donn√©es ont √©t√© effac√©es');
            setTimeout(() => location.reload(), 1000);
        }

        function loadInventory() {
            const container = document.getElementById('inventaireContainer');
            container.innerHTML = `
                <div class="service-stats">
                    ${inventory.map(item => `
                        <div class="card" style="border-left:4px solid ${item.quantity <= item.minStock ? '#FF6384' : '#4BC0C0'}">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div style="flex:1;">
                                    <strong style="font-size:1.1em;">${item.name}</strong><br>
                                    <div style="margin:10px 0;">
                                        <span style="font-size:1.5em; font-weight:bold; color:${item.quantity <= item.minStock ? '#FF6384' : '#21B5DE'}">${item.quantity}</span>
                                        <span style="color:#999; font-size:0.9em;"> ${item.unit}</span>
                                    </div>
                                    <small style="color:#999;">Stock min: ${item.minStock} ${item.unit}</small><br>
                                    <small style="color:#1A8FB8;">Prix unitaire: ${item.price} G</small>
                                    ${item.quantity <= item.minStock ? '<br><strong style="color:#FF6384;">‚ö†Ô∏è Stock faible!</strong>' : ''}
                                </div>
                                <div>
                                    <button class="btn-secondary" onclick="adjustInventory('${item.id}', 1)">‚ûï</button>
                                    <button class="btn-secondary" onclick="adjustInventory('${item.id}', -1)">‚ûñ</button>
                                    <button class="btn-secondary" onclick="editInventoryItem('${item.id}')">‚úèÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top:20px; background:#E8F7FC; padding:15px; border-radius:10px;">
                    <h4 style="color:#1A8FB8; margin-bottom:10px;">üìà Statistiques</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                        <div class="stat-card" style="background:linear-gradient(135deg, #21B5DE, #1A8FB8);">
                            <div style="font-size:1.5em; font-weight:bold;">${inventory.length}</div>
                            <div style="font-size:0.9em;">Produits</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg, #FF6384, #E5576C);">
                            <div style="font-size:1.5em; font-weight:bold;">${inventory.filter(i => i.quantity <= i.minStock).length}</div>
                            <div style="font-size:0.9em;">Stock faible</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg, #4BC0C0, #36A2EB);">
                            <div style="font-size:1.5em; font-weight:bold;">${inventory.reduce((sum, i) => sum + (i.quantity * i.price), 0)} G</div>
                            <div style="font-size:0.9em;">Valeur totale</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAddProductModal() {
            const html = `
                <div class="modal-content">
                    <h3 style="color:#1A8FB8; margin-bottom:15px; text-align:center;">‚ûï Ajouter un produit</h3>
                    <div class="form-group">
                        <label>Nom du produit</label>
                        <input type="text" id="newProductName" style="width:100%; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    </div>
                    <div class="form-group">
                        <label>Quantit√©</label>
                        <input type="number" id="newProductQty" value="0" style="width:100%; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    </div>
                    <div class="form-group">
                        <label>Unit√©</label>
                        <input type="text" id="newProductUnit" placeholder="Ex: feuilles, cartouches..." style="width:100%; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    </div>
                    <div class="form-group">
                        <label>Stock minimum</label>
                        <input type="number" id="newProductMinStock" value="10" style="width:100%; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    </div>
                    <div class="form-group">
                        <label>Prix unitaire (Gdes)</label>
                        <input type="number" id="newProductPrice" value="0" style="width:100%; padding:10px; border:2px solid #D1EFF9; border-radius:8px;">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-primary" onclick="saveNewProduct()" style="flex:1;">Enregistrer</button>
                        <button class="btn-secondary" onclick="closeModal()" style="flex:1;">Annuler</button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'clientHistoryModal';
            modal.className = 'modal-overlay';
            modal.innerHTML = html;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
            document.body.appendChild(modal);
        }

        function saveNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const qty = parseInt(document.getElementById('newProductQty').value) || 0;
            const unit = document.getElementById('newProductUnit').value.trim();
            const minStock = parseInt(document.getElementById('newProductMinStock').value) || 0;
            const price = parseFloat(document.getElementById('newProductPrice').value) || 0;
            
            if (!name || !unit) {
                showNotification('‚ö†Ô∏è Nom et unit√© requis!');
                return;
            }
            
            inventory.push({
                id: 'prod_' + Date.now(),
                name,
                quantity: qty,
                unit,
                minStock,
                price
            });
            
            localStorage.setItem('wozoprint_inventory', JSON.stringify(inventory));
            closeModal();
            loadInventory();
            showNotification('‚úÖ Produit ajout√©!');
        }

        function adjustInventory(id, delta) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            const newQty = Math.max(0, item.quantity + delta);
            const change = prompt(`${item.name}\nQuantit√© actuelle: ${item.quantity} ${item.unit}\n\nNouvelle quantit√©:`, newQty);
            
            if (change === null) return;
            
            const qty = parseInt(change);
            if (isNaN(qty) || qty < 0) {
                showNotification('‚ö†Ô∏è Quantit√© invalide!');
                return;
            }
            
            item.quantity = qty;
            localStorage.setItem('wozoprint_inventory', JSON.stringify(inventory));
            loadInventory();
            showNotification('‚úÖ Stock mis √† jour!');
        }

        function editInventoryItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            const name = prompt('Nom:', item.name);
            if (name) item.name = name;
            
            const price = prompt('Prix unitaire:', item.price);
            if (price !== null) item.price = parseFloat(price) || 0;
            
            const minStock = prompt('Stock minimum:', item.minStock);
            if (minStock !== null) item.minStock = parseInt(minStock) || 0;
            
            localStorage.setItem('wozoprint_inventory', JSON.stringify(inventory));
            loadInventory();
            showNotification('‚úÖ Produit modifi√©!');
        }

        function exportReport(format) {
            showNotification(`üì• Export ${format.toUpperCase()} en cours...`);
            
            const history = JSON.parse(localStorage.getItem('wozoprint_repartition')) || [];
            const startDate = document.getElementById('startDate')?.value || 'D√©but';
            const endDate = document.getElementById('endDate')?.value || "Aujourd'hui";
            
            if (format === 'excel') {
                const csvContent = generateCSVReport(history);
                downloadFile(csvContent, `rapport_wozoprint_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
                showNotification('‚úÖ Rapport Excel t√©l√©charg√©!');
            } else if (format === 'pdf') {
                showNotification('‚ÑπÔ∏è Pour PDF: Utilisez Imprimer > Enregistrer en PDF');
            }
        }

        function generateCSVReport(history) {
            let csv = 'Date,Montant,Amortissement,Produits,Logement,Impr√©vus,Ma Part\n';
            history.forEach(h => {
                csv += `${new Date(h.date).toLocaleDateString()},${h.amount},${h.repartition.amortissement},${h.repartition.produits},${h.repartition.tante},${h.repartition.imprevu},${h.repartition.mapart}\n`;
            });
            return csv;
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], {type});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }

        function printReport() {
            window.print();
        }

        function showNotification(message) {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.remove(), 3000);
        }
    </script>
</body>
</html>
